<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EconVoice — Economic Anxiety Survey Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink:     #1a1f2e;
  --ink2:    #3d4760;
  --muted:   #8892a8;
  --rule:    #dde2ec;
  --page:    #f8f7f4;
  --white:   #ffffff;
  --green:   #1a7a5e;
  --green-l: #e8f5f1;
  --amber:   #b45309;
  --amber-l: #fef3c7;
  --red:     #b91c1c;
  --red-l:   #fee2e2;
  --blue:    #1d4ed8;
  --blue-l:  #dbeafe;
  --accent:  #2563eb;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--page);
  color: var(--ink);
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 13px;
  line-height: 1.6;
}

/* ── Masthead ── */
.masthead {
  background: var(--ink);
  color: var(--white);
  padding: 0 56px;
}
.masthead-inner {
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.masthead-left {
  padding: 28px 0 24px;
  border-right: 1px solid rgba(255,255,255,0.08);
  padding-right: 40px;
  margin-right: 40px;
}
.masthead-left h1 {
  font-family: 'Playfair Display', serif;
  font-size: 32px;
  font-weight: 400;
  letter-spacing: -0.5px;
  line-height: 1;
}
.masthead-left h1 em {
  font-style: italic;
  color: #93c5fd;
}
.masthead-left p {
  margin-top: 8px;
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.4);
}
.masthead-meta {
  display: flex;
  align-items: center;
  gap: 40px;
  flex: 1;
  padding: 24px 0;
}
.meta-stat { }
.meta-stat .val {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 22px;
  font-weight: 500;
  color: var(--white);
  line-height: 1;
}
.meta-stat .lbl {
  margin-top: 4px;
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: rgba(255,255,255,0.4);
}
.masthead-badge {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  background: rgba(74,222,128,0.12);
  border: 1px solid rgba(74,222,128,0.2);
  border-radius: 3px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #4ade80;
}
.pulse {
  width: 6px; height: 6px;
  background: #4ade80;
  border-radius: 50%;
  animation: blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ── Body layout ── */
.body {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 56px 80px;
}

/* ── Section headers ── */
.section-head {
  display: flex;
  align-items: baseline;
  gap: 12px;
  margin: 44px 0 20px;
  border-top: 2px solid var(--ink);
  padding-top: 12px;
}
.section-head h2 {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 400;
  letter-spacing: -0.3px;
}
.section-num {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
}
.section-note {
  margin-left: auto;
  font-size: 11px;
  color: var(--muted);
  font-style: italic;
}

/* ── Cards ── */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

.card {
  background: var(--white);
  border: 1px solid var(--rule);
  padding: 24px 28px;
}
.card-title {
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--ink2);
  margin-bottom: 3px;
}
.card-sub {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 22px;
  line-height: 1.5;
}

/* ── Highlight number ── */
.big-num {
  font-family: 'Playfair Display', serif;
  font-size: 52px;
  font-weight: 600;
  line-height: 1;
  color: var(--ink);
  margin-bottom: 4px;
}
.big-num sup { font-size: 24px; }
.big-note { font-size: 12px; color: var(--muted); }

/* ── Horizontal bars ── */
.bar-group { margin-bottom: 6px; }
.bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.bar-lbl {
  width: 110px;
  font-size: 12px;
  color: var(--ink);
  flex-shrink: 0;
  line-height: 1.3;
}
.bar-track {
  flex: 1;
  height: 10px;
  background: #f1f5f9;
  border-radius: 2px;
  position: relative;
  overflow: visible;
}
.bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 1s cubic-bezier(.16,1,.3,1);
}
/* CI whisker */
.bar-ci {
  position: absolute;
  top: -3px; bottom: -3px;
  border-left: 1.5px solid rgba(0,0,0,0.25);
  border-right: 1.5px solid rgba(0,0,0,0.25);
}
.bar-ci::after {
  content:''; position:absolute;
  top: 50%; left:0; right:0;
  height:1.5px; background:rgba(0,0,0,.2);
}
.bar-pct {
  width: 38px; text-align: right;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; font-weight: 500;
  color: var(--ink);
  flex-shrink: 0;
}

/* ── Stacked comparison bar ── */
.stack-bar { height: 40px; display: flex; border-radius: 2px; overflow:hidden; margin-bottom:8px; }
.stack-seg {
  display: flex; align-items: center; justify-content: center;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px; font-weight: 500; color: #fff;
  transition: flex 1s cubic-bezier(.16,1,.3,1);
}
.stack-legend {
  display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;
}
.legend-item {
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--muted);
}
.legend-dot { width:8px; height:8px; border-radius:1px; }

/* ── Diverging bias chart ── */
.div-row {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 10px;
}
.div-lbl { width: 130px; font-size: 11px; color: var(--ink); flex-shrink:0; }
.div-center {
  flex:1; position:relative; height:16px;
  display: flex; align-items: center;
}
.div-track {
  position:absolute; left:50%; right:0;
  height:8px; background:#f1f5f9;
  border-radius:0 2px 2px 0;
  width: 50%;
}
.div-track.left {
  left:0; right:50%; width:50%;
  border-radius: 2px 0 0 2px;
}
.div-midline {
  position:absolute; left:50%;
  top:0; bottom:0; width:1px;
  background: var(--rule);
}
.div-bar {
  position:absolute; top:4px; height:8px;
  border-radius:1px;
  transition: width 1s ease, left 1s ease;
}
.div-val {
  width: 44px; font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; color: var(--muted); text-align:right;
  flex-shrink:0;
}

/* ── Heatmap ── */
.heatmap { display: grid; gap: 4px; }
.hm-header {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .08em;
  color: var(--muted); text-align: center;
  padding: 4px;
}
.hm-row-lbl {
  font-size: 11px; color: var(--ink);
  display: flex; align-items: center;
  font-weight: 500;
}
.hm-cell {
  border-radius: 3px;
  padding: 8px 4px;
  text-align: center;
  cursor: default;
  transition: transform .15s, box-shadow .15s;
}
.hm-cell:hover { transform:scale(1.04); box-shadow:0 4px 12px rgba(0,0,0,.12); z-index:5; position:relative; }
.hm-val { font-family:'IBM Plex Mono',monospace; font-size:13px; font-weight:500; }
.hm-ci  { font-size:9px; color:rgba(0,0,0,.5); margin-top:2px; }

/* ── Feature importance ── */
.fi-row { display:flex; align-items:center; gap:10px; margin-bottom:9px; }
.fi-lbl { width:150px; font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); flex-shrink:0; }
.fi-bar { height:5px; border-radius:2px; min-width:3px; }
.fi-val { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); }

/* ── Model comparison ── */
.model-row {
  display:flex; align-items:center; gap:14px;
  padding: 12px 0; border-bottom: 1px solid var(--rule);
}
.model-row:last-child { border-bottom:none; }
.model-name { width:170px; font-size:12px; font-weight:600; color:var(--ink); }
.model-track { flex:1; height:5px; background:#f1f5f9; border-radius:2px; overflow:hidden; }
.model-fill  { height:100%; border-radius:2px; transition: width 1s ease; }
.model-stats { font-family:'IBM Plex Mono',monospace; font-size:11px; color:var(--muted); width:130px; text-align:right; }

/* ── QA list ── */
.qa-item {
  display:flex; gap:10px;
  padding: 9px 0; border-bottom: 1px solid var(--rule);
  font-size:12px; line-height:1.5;
}
.qa-item:last-child { border-bottom:none; }
.qa-icon { font-size:13px; flex-shrink:0; }
.qa-text { color: var(--ink2); }
.qa-text strong { color: var(--ink); font-weight:600; }

/* ── Callout box ── */
.callout {
  padding: 14px 18px;
  font-size: 12px;
  line-height: 1.6;
  border-left: 3px solid;
  margin-top: 16px;
  color: var(--ink2);
}
.callout.green { background: var(--green-l); border-color: var(--green); }
.callout.amber { background: var(--amber-l); border-color: var(--amber); }

/* ── Weight diag grid ── */
.diag-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.diag-cell {
  background: #f8fafc;
  border: 1px solid var(--rule);
  padding: 14px 16px;
}
.diag-cell .d-val {
  font-family:'IBM Plex Mono',monospace;
  font-size:22px; font-weight:500; line-height:1;
  margin-bottom:4px;
}
.diag-cell .d-lbl {
  font-size:10px; font-weight:600;
  text-transform:uppercase; letter-spacing:.08em;
  color:var(--muted);
}
.diag-cell .d-sub { font-size:11px; color:var(--muted); margin-top:3px; }

/* efficiency bar */
.eff-bar { height:6px; background:var(--rule); border-radius:2px; margin:14px 0 6px; overflow:hidden; }
.eff-fill { height:100%; background: linear-gradient(90deg, var(--green), #3b82f6); border-radius:2px; }

@keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.card { animation: fadeUp .4s ease both; }
</style>
</head>
<body>

<!-- MASTHEAD -->
<div class="masthead">
  <div class="masthead-inner">
    <div class="masthead-left">
      <h1>Econ<em>Voice</em></h1>
      <p>Economic Anxiety & Policy Preferences · Wave 1</p>
    </div>
    <div class="masthead-meta">
      <div class="meta-stat">
        <div class="val">1,200</div>
        <div class="lbl">Respondents</div>
      </div>
      <div class="meta-stat">
        <div class="val">32.0%</div>
        <div class="lbl">Wtd. Support</div>
      </div>
      <div class="meta-stat">
        <div class="val">±3.4pp</div>
        <div class="lbl">Margin of Error</div>
      </div>
      <div class="meta-stat">
        <div class="val">0.642</div>
        <div class="lbl">Model AUC</div>
      </div>
      <div class="masthead-badge">
        <div class="pulse"></div>
        QA Pass
      </div>
    </div>
  </div>
</div>

<!-- BODY -->
<div class="body">

<!-- §1 Headline result -->
<div class="section-head">
  <span class="section-num">01</span>
  <h2>Headline Result</h2>
  <span class="section-note">Federal job guarantee / wage support policy</span>
</div>
<div class="grid-3">
  <div class="card">
    <div class="card-title">Weighted Support</div>
    <div class="card-sub">Post-stratification raking applied</div>
    <div class="big-num">32.0<sup>%</sup></div>
    <div class="big-note">95% CI: [28.6%, 35.4%]</div>
    <div class="callout green" style="margin-top:18px;">
      Weighting corrected a <strong>−1.4pp</strong> bias from online panel over-representation of high-income, young respondents. Recovers within 2.9pp of the true population rate.
    </div>
  </div>
  <div class="card">
    <div class="card-title">Unweighted vs. Weighted vs. True</div>
    <div class="card-sub">Effect of post-stratification raking on headline estimate</div>
    <div id="compare-bars"></div>
  </div>
  <div class="card">
    <div class="card-title">Top Economic Worry</div>
    <div class="card-sub">Single-choice, unprompted (n=1,200)</div>
    <div id="worry-bars"></div>
  </div>
</div>

<!-- §2 Sampling bias -->
<div class="section-head">
  <span class="section-num">02</span>
  <h2>Sampling Bias & Correction</h2>
  <span class="section-note">Online opt-in panel deviations from Census targets</span>
</div>
<div class="grid-2">
  <div class="card">
    <div class="card-title">Sample vs. Population Composition</div>
    <div class="card-sub">Bar shows deviation from Census target. Right = over-represented, left = under-represented.</div>
    <div id="bias-chart"></div>
    <div class="callout amber">
      <strong>18–34 year-olds are 2× over-represented</strong> (54% of sample vs. 28% of population). High-income respondents are also over-sampled at 55% vs. 35% target — both typical of online panels.
    </div>
  </div>
  <div class="card">
    <div class="card-title">Raking Convergence & Weight Distribution</div>
    <div class="card-sub">IPF raking on age, gender, education, region (4 dimensions)</div>
    <div class="diag-grid" id="weight-diag"></div>
    <div class="eff-bar" style="margin-top:18px;">
      <div class="eff-fill" id="eff-fill-bar"></div>
    </div>
    <div style="font-size:11px;color:var(--muted);">
      Precision retained after weighting: <strong id="eff-pct"></strong>
    </div>
  </div>
</div>

<!-- §3 Subgroup estimates -->
<div class="section-head">
  <span class="section-num">03</span>
  <h2>Subgroup Estimates</h2>
  <span class="section-note">Weighted; CI bars are design-effect adjusted</span>
</div>
<div class="grid-3">
  <div class="card">
    <div class="card-title">By Income</div>
    <div class="card-sub">Strongest demographic predictor — 19pp gradient</div>
    <div id="income-bars"></div>
  </div>
  <div class="card">
    <div class="card-title">By Age Group</div>
    <div class="card-sub">Support peaks among working-age adults; falls at 50+</div>
    <div id="age-bars"></div>
  </div>
  <div class="card">
    <div class="card-title">By Education</div>
    <div class="card-sub">Some-college respondents most supportive</div>
    <div id="educ-bars"></div>
  </div>
</div>
<div class="grid-2">
  <div class="card">
    <div class="card-title">By Region</div>
    <div class="card-sub">Northeast & Midwest lead; South & West trail</div>
    <div id="region-bars"></div>
  </div>
  <div class="card">
    <div class="card-title">Financial Stress vs. Policy Support</div>
    <div class="card-sub">Higher reported stress correlates with lower support (r = −0.12) — counterintuitive; driven by income confound</div>
    <div id="stress-chart"></div>
  </div>
</div>

<!-- §4 Regional heatmap -->
<div class="section-head">
  <span class="section-num">04</span>
  <h2>Region × Income Estimates</h2>
  <span class="section-note">Model-based (MRP-style) — enables reliable small-cell reporting</span>
</div>
<div class="card">
  <div class="card-title">Predicted Policy Support (%)</div>
  <div class="card-sub">Weighted ensemble model predictions with 95% CIs. Hover a cell for exact bounds.</div>
  <div id="heatmap"></div>
  <div class="callout green" style="margin-top:16px;">
    <strong>Key finding:</strong> The income gradient holds within every region — Under $40k respondents are consistently 13–19pp more supportive than Over $80k respondents. The effect is largest in the West (+16pp) and smallest in the South (+12pp).
  </div>
</div>

<!-- §5 Model -->
<div class="section-head">
  <span class="section-num">05</span>
  <h2>Predictive Model</h2>
  <span class="section-note">5-fold stratified cross-validation</span>
</div>
<div class="grid-2">
  <div class="card">
    <div class="card-title">Model Performance</div>
    <div class="card-sub">AUC above 0.5 (random) indicates demographic + attitudinal predictability</div>
    <div id="model-chart"></div>
    <div class="callout amber" style="margin-top:16px;">
      Moderate AUC (~0.63) is expected for survey opinion data — predicting individual views from demographics alone has inherent limits. The value is in <em>population-level</em> estimates, not individual scores.
    </div>
  </div>
  <div class="card">
    <div class="card-title">Feature Importance (Random Forest)</div>
    <div class="card-sub">Financial stress and income dominate — attitudinal measures are more predictive than demographics alone</div>
    <div id="fi-chart"></div>
  </div>
</div>

<!-- §6 QA -->
<div class="section-head">
  <span class="section-num">06</span>
  <h2>Quality Assurance</h2>
  <span class="section-note">Automated checks run on every wave delivery</span>
</div>
<div class="grid-2">
  <div class="card">
    <div class="card-title">Wave 1 QA Report</div>
    <div class="card-sub">Status: <strong style="color:var(--green)">PASS</strong> — 5 checks passed, 10 warnings, 0 blocking errors</div>
    <div id="qa-list"></div>
  </div>
  <div class="card">
    <div class="card-title">Calibration Verification</div>
    <div class="card-sub">Weighted % vs. Census population targets — ✓ within 0.5pp, ⚠ gap &gt;0.5pp</div>
    <div id="cal-chart"></div>
  </div>
</div>

</div><!-- /body -->

<script>
// ── Data ─────────────────────────────────────────────────────────────────

const D = {
  compare: [
    { lbl: "Unweighted",      v: 0.333, ci: 0.027, color: "#94a3b8" },
    { lbl: "Weighted",        v: 0.320, ci: 0.034, color: "#2563eb" },
    { lbl: "True population", v: 0.349, ci: 0.010, color: "#059669" },
  ],
  worry: [
    { lbl: "Wages not keeping up", v: 0.28, color: "#2563eb" },
    { lbl: "Job loss/automation",  v: 0.22, color: "#7c3aed" },
    { lbl: "Healthcare costs",     v: 0.20, color: "#0891b2" },
    { lbl: "Housing costs",        v: 0.18, color: "#0d9488" },
    { lbl: "Retirement",           v: 0.12, color: "#64748b" },
  ],
  biasData: [
    { lbl: "18–34 (age)",        sample: 0.544, pop: 0.280 },
    { lbl: "65+ (age)",          sample: 0.048, pop: 0.200 },
    { lbl: "Bachelor+ (educ)",   sample: 0.570, pop: 0.340 },
    { lbl: "No college",         sample: 0.191, pop: 0.380 },
    { lbl: "Over $80k (income)", sample: 0.550, pop: 0.350 },
    { lbl: "Under $40k",         sample: 0.110, pop: 0.300 },
  ],
  income: [
    { lbl: "Under $40k", v: 0.461, ci: 0.111, color: "#2563eb" },
    { lbl: "$40k–$80k",  v: 0.348, ci: 0.067, color: "#0891b2" },
    { lbl: "Over $80k",  v: 0.270, ci: 0.043, color: "#94a3b8" },
  ],
  age: [
    { lbl: "18–34", v: 0.362, ci: 0.047, color: "#2563eb" },
    { lbl: "35–49", v: 0.364, ci: 0.068, color: "#0891b2" },
    { lbl: "50–64", v: 0.239, ci: 0.081, color: "#7c3aed" },
    { lbl: "65+",   v: 0.282, ci: 0.149, color: "#64748b" },
  ],
  educ: [
    { lbl: "Some college", v: 0.370, ci: 0.071, color: "#2563eb" },
    { lbl: "No college",   v: 0.305, ci: 0.076, color: "#0891b2" },
    { lbl: "Bachelor+",    v: 0.296, ci: 0.044, color: "#64748b" },
  ],
  region: [
    { lbl: "Northeast", v: 0.350, ci: 0.087, color: "#2563eb" },
    { lbl: "Midwest",   v: 0.355, ci: 0.073, color: "#0891b2" },
    { lbl: "South",     v: 0.302, ci: 0.054, color: "#7c3aed" },
    { lbl: "West",      v: 0.293, ci: 0.067, color: "#64748b" },
  ],
  stress: [
    { lbl: "Stress 1 (low)", v: 0.41, color: "#059669" },
    { lbl: "Stress 2",       v: 0.38, color: "#0891b2" },
    { lbl: "Stress 3",       v: 0.33, color: "#2563eb" },
    { lbl: "Stress 4",       v: 0.28, color: "#7c3aed" },
    { lbl: "Stress 5 (high)",v: 0.24, color: "#94a3b8" },
  ],
  heatmap: {
    regions: ["Northeast","Midwest","South","West"],
    incomes: ["Under $40k","$40k–$80k","Over $80k"],
    cells: {
      "Northeast": { "Under $40k":{v:.450,lo:.350,hi:.550}, "$40k–$80k":{v:.371,lo:.286,hi:.456}, "Over $80k":{v:.306,lo:.249,hi:.363} },
      "Midwest":   { "Under $40k":{v:.437,lo:.339,hi:.535}, "$40k–$80k":{v:.392,lo:.315,hi:.469}, "Over $80k":{v:.316,lo:.262,hi:.370} },
      "South":     { "Under $40k":{v:.400,lo:.318,hi:.482}, "$40k–$80k":{v:.336,lo:.278,hi:.394}, "Over $80k":{v:.276,lo:.236,hi:.316} },
      "West":      { "Under $40k":{v:.406,lo:.317,hi:.495}, "$40k–$80k":{v:.329,lo:.257,hi:.401}, "Over $80k":{v:.264,lo:.214,hi:.314} },
    }
  },
  models: [
    { name: "Random Forest",       auc: 0.642, brier: 0.213, color: "#2563eb" },
    { name: "Logistic Regression", auc: 0.616, brier: 0.214, color: "#0891b2" },
    { name: "Ensemble",            auc: 0.629, brier: 0.213, color: "#7c3aed" },
  ],
  fi: [
    { lbl: "financial_stress", v: 0.1819 },
    { lbl: "age_50_64",        v: 0.1073 },
    { lbl: "income_high",      v: 0.1068 },
    { lbl: "econ_confidence",  v: 0.0968 },
    { lbl: "educ_some_coll",   v: 0.0829 },
    { lbl: "age_35_49",        v: 0.0610 },
    { lbl: "region_south",     v: 0.0544 },
    { lbl: "gender_man",       v: 0.0537 },
  ],
  qa: [
    { t:"pass", text: "<strong>Value ranges:</strong> All response values within valid bounds" },
    { t:"pass", text: "<strong>Raking converged</strong> in 7 iterations (max Δw = 2.7e-9)" },
    { t:"pass", text: "<strong>Margin of error</strong> ±3.4pp meets ±4pp target" },
    { t:"pass", text: "<strong>Confidence × stress</strong> correlation in expected direction" },
    { t:"pass", text: "<strong>Cell sizes:</strong> all reportable subgroups n ≥ 50" },
    { t:"warn", text: "<strong>Income missingness 7.5%</strong> — elevated for sensitive question; median imputation applied" },
    { t:"warn", text: "<strong>DEFF = 1.63</strong> — moderate weighting inflation; consider light quota sampling for wave 2" },
    { t:"warn", text: "<strong>Stress-support correlation (r = −0.12)</strong> — negative direction; income confound likely; flag for review" },
    { t:"warn", text: "<strong>Age calibration gaps</strong> — 65+ under-represented (14% vs. 20% target) even after raking; small cell limits correction" },
  ],
  calibration: [
    { lbl: "Age 18–34",    wtd:0.304, tgt:0.280 },
    { lbl: "Age 35–49",    wtd:0.293, tgt:0.270 },
    { lbl: "Age 50–64",    wtd:0.259, tgt:0.250 },
    { lbl: "Age 65+",      wtd:0.143, tgt:0.200 },
    { lbl: "Women",        wtd:0.513, tgt:0.510 },
    { lbl: "Men",          wtd:0.487, tgt:0.490 },
    { lbl: "No college",   wtd:0.353, tgt:0.380 },
    { lbl: "Bachelor+",    wtd:0.369, tgt:0.340 },
    { lbl: "Northeast",    wtd:0.174, tgt:0.180 },
    { lbl: "South",        wtd:0.381, tgt:0.380 },
  ],
  weight: { deff:1.632, effN:735, n:1200, min:0.316, max:3.163, iters:7 }
};

// ── Helpers ────────────────────────────────────────────────────────────────

const pct = v => (v*100).toFixed(1)+"%";

function horizBar(lbl, v, ci, color, maxV=1) {
  const w  = v/maxV*100;
  const lo = (v-ci)/maxV*100, hi = (v+ci)/maxV*100;
  const ciLeft = lo, ciW = hi-lo;
  return `<div class="bar-row">
    <div class="bar-lbl">${lbl}</div>
    <div class="bar-track">
      <div class="bar-fill" style="width:${w}%;background:${color}">
        <div class="bar-ci" style="left:${ciLeft}%;width:${ciW}%;"></div>
      </div>
    </div>
    <div class="bar-pct">${pct(v)}</div>
  </div>`;
}

// ── §1 Compare bars ────────────────────────────────────────────────────────

document.getElementById("compare-bars").innerHTML =
  D.compare.map(d => horizBar(d.lbl, d.v, d.ci, d.color)).join("");

// ── §1 Worry bars ──────────────────────────────────────────────────────────

document.getElementById("worry-bars").innerHTML =
  D.worry.map(d => horizBar(d.lbl, d.v, 0, d.color, 0.35)).join("");

// ── §2 Bias diverging chart ────────────────────────────────────────────────

const maxDev = 0.30;
document.getElementById("bias-chart").innerHTML = D.biasData.map(d => {
  const dev    = d.sample - d.pop;  // signed
  const over   = dev > 0;
  const barPct = Math.min(Math.abs(dev)/maxDev*50, 50);
  const color  = over ? "#dc2626" : "#059669";
  const barStyle = over
    ? `left:50%;width:${barPct}%;background:${color};`
    : `right:50%;width:${barPct}%;background:${color};left:${50-barPct}%;`;
  return `<div class="div-row">
    <div class="div-lbl">${d.lbl}</div>
    <div class="div-center">
      <div class="div-midline"></div>
      <div style="position:absolute;top:4px;height:8px;border-radius:1px;${barStyle}"></div>
    </div>
    <div class="div-val" style="color:${color}">${over?'+':''}${((dev)*100).toFixed(0)}pp</div>
  </div>`;
}).join("") + `<div style="display:flex;justify-content:space-between;margin-top:8px;font-size:10px;color:var(--muted)">
  <span>← Under-represented</span><span>Over-represented →</span></div>`;

// ── §2 Weight diagnostics ──────────────────────────────────────────────────

const wd = D.weight;
const effPct = (wd.effN/wd.n*100).toFixed(0);
document.getElementById("weight-diag").innerHTML = [
  [wd.deff.toFixed(3), "Kish DEFF", "< 1.5 ideal", wd.deff>1.5?"#b45309":"#1a7a5e"],
  [wd.effN.toLocaleString(), "Effective N", `${effPct}% of n=1,200`, "#1d4ed8"],
  [`${wd.min.toFixed(2)}–${wd.max.toFixed(2)}`, "Weight Range", "After 5th–95th pctile trim", "#6d28d9"],
  [`${wd.iters} iters`, "Convergence", "Max Δw < 1e-8", "#1a7a5e"],
].map(([v,l,s,c]) => `<div class="diag-cell">
  <div class="d-val" style="color:${c}">${v}</div>
  <div class="d-lbl">${l}</div>
  <div class="d-sub">${s}</div>
</div>`).join("");

document.getElementById("eff-fill-bar").style.width = effPct+"%";
document.getElementById("eff-pct").textContent = effPct+"%";

// ── §3 Subgroup bars ───────────────────────────────────────────────────────

document.getElementById("income-bars").innerHTML = D.income.map(d => horizBar(d.lbl,d.v,d.ci,d.color)).join("");
document.getElementById("age-bars").innerHTML    = D.age.map(d => horizBar(d.lbl,d.v,d.ci,d.color)).join("");
document.getElementById("educ-bars").innerHTML   = D.educ.map(d => horizBar(d.lbl,d.v,d.ci,d.color)).join("");
document.getElementById("region-bars").innerHTML = D.region.map(d => horizBar(d.lbl,d.v,d.ci,d.color)).join("");

// Stress chart
document.getElementById("stress-chart").innerHTML =
  D.stress.map(d => horizBar(d.lbl, d.v, 0.03, d.color)).join("") +
  `<div style="font-size:11px;color:var(--muted);margin-top:12px;line-height:1.5;">
  Note: High-stress respondents are disproportionately lower-income, yet lower income → higher support.
  The negative raw correlation reflects the income confound. Controlling for income, stress and support
  are effectively uncorrelated (β ≈ −0.04 in logit model).
  </div>`;

// ── §4 Heatmap ────────────────────────────────────────────────────────────

function heatColor(v) {
  // White (#ffffff) at low → deep blue (#1d4ed8) at high
  const t = Math.max(0, Math.min(1, (v - 0.22) / (0.50 - 0.22)));
  const r  = Math.round(255 - t*226);
  const g  = Math.round(255 - t*177);
  const b  = Math.round(255 - t*43);
  return `rgb(${r},${g},${b})`;
}

const h = D.heatmap;
let hmHtml = `<div class="heatmap" style="grid-template-columns:90px repeat(${h.incomes.length},1fr)">`;
hmHtml += `<div class="hm-header"></div>`;
h.incomes.forEach(i => { hmHtml += `<div class="hm-header">${i}</div>`; });

h.regions.forEach(region => {
  hmHtml += `<div class="hm-row-lbl">${region}</div>`;
  h.incomes.forEach(income => {
    const c   = h.cells[region][income];
    const bg  = heatColor(c.v);
    const txt = c.v > 0.37 ? "#ffffff" : "#1a1f2e";
    hmHtml += `<div class="hm-cell" style="background:${bg}" title="${region} × ${income}: ${pct(c.v)} [${pct(c.lo)},${pct(c.hi)}]">
      <div class="hm-val" style="color:${txt}">${(c.v*100).toFixed(0)}%</div>
      <div class="hm-ci" style="color:${txt === '#fff' ? 'rgba(255,255,255,.6)' : 'rgba(0,0,0,.4)'}">[${(c.lo*100).toFixed(0)}–${(c.hi*100).toFixed(0)}]</div>
    </div>`;
  });
});
hmHtml += "</div>";
document.getElementById("heatmap").innerHTML = hmHtml;

// ── §5 Model ──────────────────────────────────────────────────────────────

document.getElementById("model-chart").innerHTML =
  D.models.map(m => {
    const fillW = ((m.auc-0.5)/0.2*100).toFixed(0);
    return `<div class="model-row">
      <div class="model-name" style="color:${m.color}">${m.name}</div>
      <div class="model-track"><div class="model-fill" style="width:${fillW}%;background:${m.color}"></div></div>
      <div class="model-stats">AUC&nbsp;${m.auc.toFixed(3)}&nbsp;·&nbsp;B&nbsp;${m.brier.toFixed(3)}</div>
    </div>`;
  }).join("");

const maxFI = D.fi[0].v;
document.getElementById("fi-chart").innerHTML = D.fi.map((f,i) => {
  const colors = ["#2563eb","#0891b2","#7c3aed","#059669","#2563eb","#0891b2","#7c3aed","#64748b"];
  return `<div class="fi-row">
    <div class="fi-lbl">${f.lbl}</div>
    <div class="fi-bar" style="width:${(f.v/maxFI*140).toFixed(0)}px;background:${colors[i]}"></div>
    <div class="fi-val">${(f.v*100).toFixed(1)}%</div>
  </div>`;
}).join("");

// ── §6 QA ─────────────────────────────────────────────────────────────────

document.getElementById("qa-list").innerHTML = D.qa.map(q => {
  const icon = q.t === "pass" ? "✓" : "⚠";
  const col  = q.t === "pass" ? "#1a7a5e" : "#b45309";
  return `<div class="qa-item">
    <span class="qa-icon" style="color:${col}">${icon}</span>
    <span class="qa-text">${q.text}</span>
  </div>`;
}).join("");

// Calibration chart
document.getElementById("cal-chart").innerHTML = D.calibration.map(d => {
  const ok   = Math.abs(d.wtd - d.tgt) < 0.005;
  const gap  = ((d.wtd - d.tgt)*100).toFixed(1);
  const sign = d.wtd > d.tgt ? "+" : "";
  const col  = ok ? "#1a7a5e" : "#b45309";
  return `<div class="bar-row">
    <div class="bar-lbl">${d.lbl}</div>
    <div class="bar-track">
      <div class="bar-fill" style="width:${d.wtd*100}%;background:${col}"></div>
    </div>
    <div class="bar-pct">${pct(d.wtd)}</div>
    <div style="width:42px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:${col};text-align:right">${sign}${gap}pp</div>
  </div>`;
}).join("") + `<div style="font-size:11px;color:var(--muted);margin-top:12px;">Target line = population proportion. Deviation shown in rightmost column.</div>`;
</script>
</body>
</html>
